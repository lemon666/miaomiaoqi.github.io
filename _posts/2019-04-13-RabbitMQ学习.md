---
layout: post
title:  "RabbitMQ学习"
date:   2019-04-13 16:35:25
categories: MessageQueue
tags: RabbitMQ
author: miaoqi
---

* content
{:toc}

# RabbitMQ介绍

RabbitMQ是使用Erlang语言开发的开源消息队列系统, 基于 AMQP 协议来实现. AMQP 的主要特征是面向消息, 队列, 路由(包括点对点和发布/订阅), **可靠性, 安全**. **AMQP 协议更多用在企业系统内, 对数据一致性, 稳定性和可靠性要求很高的场景, 对性能和吞吐量的要求还在其次.**

## 哪些大厂在使用RabbitMQ?

滴滴, 美团, 头条, 去哪儿, 艺龙…...

**开源, 性能优秀, 稳定性保障**

提供可靠性投递模式(confirm), 返回模式(return)

与SpringAMQP完美的整合, API丰富

集群模式丰富, 表达式配置, HA模式, 镜像队列模式

保证数据不丢失的前提下做到高可靠性, 可用性

## RabbitMQ高性能的原因

Erlang 语言最初在于交换机领域的架构模式, 这样使得 RabbitMQ 在 Broker 之间进行数据交互的性能是非常优秀的

Erlang的优点: Erlang 有着和原生 Socket 一样的延迟



# AMQP高级消息队列协议(Advanced Message Queuing Protocol)

具有现代特征的二进制协议, 是一个提供统一消息服务的应用层标准高级消息队列协议, 是应用层协议的一个开放标准, 为面向消息的中间件设计.

## AMQP协议模型

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_2.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_2.png)

## AMQP核心概念

**Server:** 又称 Broker, 接受客户端的连接, 实现 AMQP 实体服务.

**Connection:** 连接, 应用程序与 Broker 的网络连接, 类似JDBC连接.

**Channel:** 网络信道, 几乎所有的操作都在 Channel 中进行, Channel 是进行消息读写的通道. 客户端可建立多个 Channel, 每个 Channel 代表一个会话任务.

**Message:** 消息, 服务器和应用程序之间传送的数据, 由 Properties 和 Body 组成. Properties 可以对消息进行修饰, 比如消息的优先级, 延迟等高级特性; Body 则就是消息体内容.

**Virtual host:** 虚拟地址, 用于进行逻辑隔离, 最上层的消息路由. 一个 Virtual Host 里面可以有若干个 Exchange 和 Queue, 同一个 Virtual 里面不能有相同名称的 Exchange 和 Queue, RabbitMQ 默认的 vhost 是 "/".

**Exchange: **交换机, 接收消息, 根据路由键转发消息到绑定的队列.

**Binding: ** Exchange 和 Queue 之间的虚拟连接, binding 中可以包含 routing key

**Routing key: ** 一个路由规则, 虚拟机可以用它来确定如何路由一个特定的消息

**Queue: **也成为 Message Queue, 消息队列, 保存消息并将它们转发给消费者

# RabbitMQ单机架构

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_3.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_3.png)

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_4.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_4.png)

# RabbitMQ的安装

**官网地址:** http://www.rabbitmq.com/

我使用的是 brew 安装 rabbitmq

`brew install rabbitmq`

# RabbitMQ的使用

**服务的启动:** `rabbitmq-server start &`

**服务的停止: **`rabbitmqctl stop_app`

**管理插件: **`rabbitmq-plugins enable rabbitmq_management`

**查看插件列表: **`rabbitmq-plugins list`

**服务端口:** 5672

**后台访问地址: ** http://localhost:15672

**集群端口: **25672

## 命令行与管控台操作

### 基础操作

关闭应用: `rabbitmqctl stop_app`

启动应用: `rabbitmqctl start_app`

节点状态: `rabbitmqctl status`

### 用户操作

添加用户: `rabbitmqctl add_user username password`

列出用户: `rabbitmqctl list_users`

删除用户: `rabbitmqctl delete_user username`

清除用户权限: `rabbitmqctl clear_permissions -p vhostpath username`

列出用户权限: `rabbitmqctl list_user_permissions username`

修改密码: `rabbitmqctl change_password username newpassword`

设置用户权限: `rabbitmqctl set_permissions -p vhostpath username ".*" ".*" ".*"`

### 虚拟机操作

创建虚拟主机: `rabbitmqctl add_vhost vhostpath`

列出所有虚拟主机: `rabbitmqctl list_vhosts`

列出虚拟主机上所有权限: `rabbitmqctl list_permissions-p vhostpath`

删除虚拟主机: `rabbitmqctl delete_vhost vhostpath`

### 队列操作

查看所有队列信息: `rabbitmqctl list_queues --vhost /`

清除队列里的消息: `rabbitmqctl -p vhostpath purge_queue blue`

### 高级操作

移除所有数据(要在 rabbitmqctl stop_app 之后使用): `rabbitmqctl reset`

组成集群: `rabbitmqctl join_cluster <clustermode> [--ram]`

查看集群状态: `rabbitmqctl cluster_status`

修改集群节点的存储形式: `rabbitmqctl change_cluster_node_type disc|ram`

忘记节点(摘除节点): `rabbitmqctl forget_cluster_node [--offline]`

修改节点名称: `rabbitmqctl rename_cluster_node oldnode1 newnode1 [oldnode2] [newnode2...]`

# RabbitMQ消息生产与消费-快速入门

1. 获取连接工厂: ConnectionFactory
2. 获取连接: Connection
3. 数据通信信道, 可以接收和发送数据: Channel
4. 具体的消息存储队列: Queue
5. 生产者和消费者: Producer&Consumer

# Exchange 交换机

接收消息, 并根据路由键转发消息所绑定的队列

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_5.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_5.png)

## 交换机属性

**Name: **交换机名称

**Type: **交换机类型 direct, topic, fanout, headers

**Durability: **是否需要持久化, true 为持久化

**Auto Delete: **当最后一个绑定到 Exchange 上的队列删除后, 自动删除该 Exchange

**Internal: **当前 Exchange 是否用于 RabbitMQ 内部使用, 默认为 False

**Arguments: **扩展参数, 用于扩展 AMQP 协议自定义化使用

## Direct Exchange

所有发送到 Direct Exchange 的消息被转发到  RoutingKey 中指定的 Queue

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_6.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_6.png)

## Topic Exchange

所有发送到 Topic Exchange 的消息被转发到所有关心 RoutingKey 中指定 Topic 的 Queue 上

Exchange 将 RoutingKey 和某 Topic 进行模糊匹配, 此时队列需要绑定一个 Topic

模糊匹配可以使用通配符:

* #: 匹配一个或多个词
* *: 匹配不多不少一个词

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_7.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_7.png)

## Fanout Exchange

不处理路由键,  只需要简单的将队列绑定到交换机上

**发送到交换机的消息都会被转发到与该交换机绑定的所有队列上, 无论 routingKey 是什么都会被转发**

**Fanout 交换机速度是最快的**

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_8.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_8.png)







# RabbitMQ集群架构

![http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_1.png](http://www.miaomiaoqi.cn/images/mq/rabbitmq/rabbitmq_1.png)

