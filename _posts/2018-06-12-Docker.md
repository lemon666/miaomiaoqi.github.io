---
layout: post
title:  "Docker学习"
date:   2018-06-12 21:12:38
categories: Container
tags: Docker
author: miaoqi
---

* content
{:toc}


# Docker介绍

## Docker 服务器与客户端

Docker是一个客户端-服务器(C/S)架构程序. Docker客户端只需要向 Docker 服务器或者守护进程发出请求, 服务器或者守护进程将完成所有工作并返回结果. Docker 提供了一个命令行工具Docker 以及一整套 RESTfulAPI. 你可以在同一台宿主机上运行 Docker 守护进程和客户端, 也可以从本地的 Docker 客户端连接到运行在另一台宿主机上的远程 Docker守护进程

![http://www.miaomiaoqi.cn/images/container/docker/docker_1.png](http://www.miaomiaoqi.cn/images/container/docker/docker_1.png)

## Docker 镜像与容器

镜像是构建 Docker 的基石. 用户基于镜像来运行自己的容器. 镜像也是 Docker 生命周期中的"构建"部分. 镜像是基于联合文件系统的一种层式结构, 由一系列指令一步一步构建出来

## 注册中心

Docker 用 Registry 来保存用户构建的镜像. Registry 分为公共和私有两种. Docker 公司运营公共的 Registry 叫做 Docker Hub. 用户可以在 Docker Hub 注册账号, 分享并保存自己的镜像



# 核心概念

docker镜像(Images): Docker镜像是用于创建Docker容器的模板

docker容器(Container): 容器是独立运行的一个或一组容器

docker客户端(Client): 客户端通过命令行或者其他工具使用Docker

docker主机(Host): 安装了Docker程序的机器(Docker直接安装在操作系统上)

docker仓库(Registry): Docker仓库用来保存镜像, 可以理解为代码控制中的代码仓库

# 使用Docker步骤

1. 安装Docker

1. 去Docker仓库找到这个软件对应的仓库

1. 使用Docker运行这个镜像, 这个镜像就会生成一个Docker容器

1. 对容器的启动停止就是对软件的启动停止

# 镜像操作

|操作|命令|说明|
|-----|-----|-----|
|检索|docker search redis|查看镜像信息|
|拉取|docker pull 镜像名:tag|:tag是可选的, tag表示标签, 多为软件的版本, 默认是latest|
|列表|docker images|查看所有本地镜像|
|删除|docker rmi image-id<br />docker rmi \`docker images -q\`|删除指定的本地镜像<br/>删除所有镜像|

# 容器操作

|操作|命令|说明|
|-----|-----|-----|
|创建|docker run --name container-name -d image-name:tag|-name: 自定义容器名<br />-d: 后台运行 image-name: 指定镜像模板<br />-i: 运行容器<br />-t: 容器启动后会进入其命令行<br />-v: 宿主机目录:容器目录(前者是宿主机目录, 后者是映射到宿主机上的目录), 可以使用多个-v 做多个映射<br />-p: 宿主机端口:容器端口(前者是宿主机端口, 后者是容器内的端口)|
|列表|docker ps|查看运行中的容器<br />-a: 查看全部容器|
|进入容器|docker exec -it container-id /bin/bash|进入容器|
|root 权限进入容器|sudo docker exec -it -u root  container-id /bin/bash|root 权限进入容器|
|启动|docker start container-name/container-id|启动容器|
|文件拷贝|docker cp 需要拷贝的文件或目录 容器名称:容器目录|拷贝文件, 反之也可以|
|查看容器 ip|docker inspect container-id<br />docker inspect —format='{{.NetworkSettings.IPAddress}}' container-id|查看容器运行的各种数据<br />过滤想要的数据|
|停止|docker stop container-name/container-id|停止当前运行的容器|
|停止全部容器|docker stop $(docker ps -q)|停止全部容器|
|删除|docker rm container-id|删除指定容器|
|删除全部容器|docker rm $(docker ps -aq)|删除全部容器|
|容器日志|docker logs container-name/container-id||
|更多命令|https://docs.docker.com/engine/reference/commandline/docker/||

1. docker search tomcat

1. docker pull tomcat

1. docker run --name mytomcat -d tomcat:latest

1. docker run -d --name mytomcat -p 9999:8080 tomcat:latest

docker run -d --name mysql01 -e MYSQL_ROOT_PASSWORD=miaoqi -p 4306:3306 mysql

# 应用部署

## MySQL 部署

拉取 mysql 镜像    

```
docker pull mysql
```

创建容器

```
docker run -d --name=tensquare_mysql -p 33306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql
```

## Tomcat部署

拉取 tomcat 镜像

```
docker pull tomcat
```

创建容器

```
docker run -d --name=mytomcat -p 9000:8080 -v /usr/local/webapps:/usr/local/tomcat/webapps tomcat
```

# 迁移与备份

## 容器保存为镜像

```
# docker commit container-name image-name
docker commit mytomcat mytomcat_i
```

## 镜像备份

```
# docker save -o file-name image-name
docker save -o mytomcat.tar mytomcat_i
```

## 镜像恢复

```
# docker load -i file-name
docker load -i mytomcat.tar
```

# Dockerfile

Dockerfile 是由一系列命令和参数构成的脚本, 这些命令应用于基础镜像并最终创建一个新的镜像

对于开发人员: 可以为开发团队提供一个完全一致的开发环境

对于测试人员: 可以直接拿开发时所构建的镜像或者通过 Dockerfile 文件构建一个新的镜像开始工作

对于运维人员: 在部署时, 可以实现应用的无缝移植

| 命令                               | 作用                                                         |
| ---------------------------------- | ------------------------------------------------------------ |
| FROM image_name:tag                | 定义了使用哪个基础镜像启动构建程序                           |
| MAINTAINER user_name               | 声明镜像的创建者                                             |
| ENV key value                      | 设置环境变量(可以写多条)                                     |
| RUN command                        | 是 Dockerfile的核心部分(可以写多条)                          |
| ADD source_dir/file dest_dir/file  | 将宿主机的文件复制到容器内, 如果是一个压缩文件, 将会在复制后自动解压 |
| COPY source_dir/file dest_dir/file | 和 ADD 相似, 但是如果有压缩文件并不能解压                    |
| WORKDIR path_dir                   | 设置工作目录                                                 |

## 构建自己的 JDK1.8 镜像

**编写构建脚本**

```
# 基础镜像
FROM centos:7
# 创建者
MAINTAINER miaoqi
# 工作目录
WORKDIR /user
# 创建 java 目录
RUN mkdir /usr/local/java
# 将宿主机的文件拷贝到指定目录
ADD jdk-8u211-linux-x64.tar.gz /usr/local/java

# 设置环境变量
ENV JAVA_HOME=/usr/local/java/jdk1.8.0_211
ENV JRE_HOME=$JAVA_HOME/jre
ENV CLASSPATH $JAVA_HOME/bin/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib:$CLASSPATH
ENV PATH $JAVA_HOME/bin:$PATH
```

**执行构建命令**

```
docker build -t='jdk1.8' .
```



# 安装基础软件

在使用 sudo 执行命令之前，需要把该普通用户添加到 /etc/sudoers 文件：

1. 切换到 root 用户，使用命令 visudo 进入 vim ，看到它已打开了 /etc/sudoers 文件。

2. 输入 "/root" 搜索，找到 "root   ALL=(ALL)      ALL" 这行，按 "yyp" 键得到一行拷贝，修改为"username ALL=(ALL)      ALL"，"username" 是要添加的用户名。

（如果在使用 sudo 时不想输入用户密码，请修改为 "`username ALL=(ALL) NOPASSWD:ALL`"）

```
apt-get update
```

```
sudo apt-get upgrade
```

```
sudo apt-get dist-upgrade
```

```
apt-get -y install sudo
```

```
apt-get -y install yum
```

```
apt-get -y install bash-completion
```

```
apt-get -y install vim
```

```
sudo dpkg-reconfigure dash  选择 no 变为 bash
```

