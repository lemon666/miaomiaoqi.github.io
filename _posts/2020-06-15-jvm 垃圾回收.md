---
layout: post
title: jvm 垃圾回收
categories: [Java]
description: 
keywords: 
---

* content
{:toc}


## 如何判断对象可以回收

### 引用计数法

无法避免循环引用方法

### 可达性分析法

Java 虚拟机中的垃圾回收器采用可达性分析来探索所有存活的对象

扫描堆中的对象，看是否能够沿着 GC Root对象 为起点的引用链找到该对象，找不到，表示可以回收

哪些对象可以作为 GC Root ?





### 四种引用

1.  强引用

    只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收

2.  软引用（SoftReference）

    仅有软引用引用该对象时，在垃圾回收后，内存仍不足时会再次出发垃圾回收，回收软引用对象

    可以配合引用队列来释放软引用自身

3.  弱引用（WeakReference）

    仅有弱引用引用该对象时，在垃圾回收时，无论内存是否充足，都会回收弱引用对象

    可以配合引用队列来释放弱引用自身

4.  虚引用（PhantomReference）

    必须配合引用队列使用，主要配合 ByteBuffer 使用，被引用对象回收时，会将虚引用入队，由 Reference Handler 线程调用虚引用相关方法释放直接内存

5.  终结器引用（FinalReference）

    无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由 Finalizer 线程通过终结器引用找到被引用对象并调用它的 finalize方法，第二次 GC 时才能回收被引用对象





## 垃圾回收算法

### 标记清除

Mark Sweep

速度较快

### 标记整理

Mark Compact

速度慢



### 复制

Copy

不会有内存碎片

需要占用双倍内存空间





## 分代垃圾回收

![http://www.milky.show/images/java/jvm/jvm_10.png](http://www.milky.show/images/java/jvm/jvm_10.png)

对象首先分配在伊甸园区域

新生代空间不足时，触发 minor gc，伊甸园和 from 存活的对象使用 copy 复制到 to 中，存活的对象年龄加 1并且交换 from to

minor gc 会引发 stop the world，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行

当对象寿命超过阈值时，会晋升至老年代，最大寿命是15（4bit）

当老年代空间不足，会先尝试触发 minor gc，如果之后空间仍不足，那么触发 full gc，STW的时间更长



### 相关 JVM 参数

| 含义                   | 参数                                                         |
| ---------------------- | ------------------------------------------------------------ |
| 堆初始大小             | -Xms                                                         |
| 堆最大大小             | -Xmx 或 -XX:MaxHeapSize=size                                 |
| 新生代大小             | -Xmn 或 (-XX:NewSize=size + -XX:MaxNewSize=size )            |
| 幸存区比例（动态）     | -XX:InitialSurvivorRatio=ratio 和 -XX:+UseAdaptiveSizePolicy |
| 幸存区比例(伊甸园占比) | -XX:SurvivorRatio=ratio                                      |
| 晋升阈值               | -XX:MaxTenuringThreshold=threshold                           |
| 晋升详情               | -XX:+PrintTenuringDistribution                               |
| GC详情                 | -XX:+PrintGCDetails -verbose:gc                              |
| FullGC 前 MinorGC      | -XX:+ScavengeBeforeFullGC                                    |



## 垃圾回收器

## 垃圾回收调优