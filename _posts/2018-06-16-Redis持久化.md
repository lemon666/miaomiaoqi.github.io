---
layout: post
title:  "Redis持久化"
date:   2018-06-14 15:12:38
categories: NoSql
tags: Redis
author: miaoqi
---

* content
{:toc}

## RDB快照

* 把内存中的数据来一份一模一样的放在硬盘中, 会丢失掉最后一部分存储的数据, 适合大规模的数据恢复, 对数据完整性和一致性要求不高, 默认是这种方式

* Redis会单独创建(fork)一个子进程来进行持久化, 会先将数据写入到一个临时文件中, 待持久化过程结束后, 再用这个临时文件替换上次持久化的文件, 整个过程中, 主进程不进行任何IO操作, 这就确保了极高的性能

* 隐患:

    若当前的进程数据量庞大, fork之后数据量*2, 会造成服务器压力过大

* save 900 1: 900秒内1次操作会备份

* save 60 10000: 60秒内10000次操作会备份

* save "": 不备份

## AOF保存命令日志

* 把每一条对redis的写操作命令, 也支持每秒同步和不同步, 保存到类似日志文件中文件采用Redis协议的格式来保存, 新命令会追加到文件末尾, 配置文件中appendonly yes开启aof持久化, 日志文件过大新增了重写机制, 相同数据集而言, aof文件要远大于rdb文件, 恢复速度慢于rdb, 运行效率也要慢于rdb文件

* 如果只做缓存, 可以不适用任何持久化方式

* 如果两个持久化方案同时开启, 优先采用aof方式, 因为aof保存的数据要比rdb完整

* 建议同时开启rdb和aof, rdb适合备份数据库, 因为aof在不断变化, 不好备份, 可以快速重启, 作为以防万一的手段

## 备份

* RDB 文件一旦被创建， 就不会进行任何修改。 当服务器要创建一个新的 RDB 文件时， 它先将文件的内容保存在一个临时文件里面， 当临时文件写入完毕时， 程序才使用 rename(2) 原子地用临时文件替换原来的 RDB 文件。这也就是说， 无论何时， 复制 RDB 文件都是绝对安全的。创建一个定期任务（cron job）， 每小时将一个 RDB 文件备份到一个文件夹， 并且每天将一个 RDB 文件备份到另一个文件夹。




    
    
    
    
    
    
    
    
    
    