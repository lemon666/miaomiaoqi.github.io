---
layout: post
title:  "MySQL索引与字段的关系"
date:   2018-01-14 11:24:42
categories: RDBMS
tags: MySQL
author: miaoqi
---

* content
{:toc}
# MySQL索引与字段的关系

* 在做Quartz的练习时, 需要创建Quartz需要用到的表, 但是在执行SQL的过程中报出如下错误

	**Error : Specified key was too long; max key length is 767 bytes**

	这句话的意思是索引的最大长度为767字节（byte）, 而我得索引列长度超过了767字节, 所以报出上述的错误, 接下来我们具体分析一下这个错误

* 首先看一下建表语句

	```
	CREATE TABLE QRTZ_JOB_DETAILS(
	    SCHED_NAME VARCHAR(120) NOT NULL,
	    JOB_NAME VARCHAR(200) NOT NULL,
	    JOB_GROUP VARCHAR(200) NOT NULL,
	    DESCRIPTION VARCHAR(250) NULL,
	    JOB_CLASS_NAME VARCHAR(250) NOT NULL,
	    IS_DURABLE VARCHAR(1) NOT NULL,
	    IS_NONCONCURRENT VARCHAR(1) NOT NULL,
	    IS_UPDATE_DATA VARCHAR(1) NOT NULL,
	    REQUESTS_RECOVERY VARCHAR(1) NOT NULL,
	    JOB_DATA BLOB NULL,
		PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)
	)ENGINE=InnoDB;
	```

	我们可以看到这个建表语句创建了一个复合索引**PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)**, 我创建数据库的时候使用的是utf8mb4字符集, **一个字符会占用4个字节**, 而3个字段的长度是120 + 200 + 200 = 520, 复合索引的长度是2080字节, 单个索引的长度分别是480, 800, 800字节

* **经过查阅得知, MySQL在创建单个字段索引时, 主要的限制是字段长度, 如果单个字段长度不超过767字节, 不会出现问题但复合索引的情况与单字段索引有所不同. 复合索引中除了单字段长度不能超过767字节外, 索引中所有字段长度的总合不能超过3072字节. **

## 测试单列索引的情况

* 首先修改创建表的语句如下

	```
	CREATE TABLE QRTZ_JOB_DETAILS(
	    SCHED_NAME VARCHAR(120) NOT NULL,
	    JOB_NAME VARCHAR(200) NOT NULL,
	    JOB_GROUP VARCHAR(200) NOT NULL,
	    DESCRIPTION VARCHAR(250) NULL,
	    JOB_CLASS_NAME VARCHAR(250) NOT NULL,
	    IS_DURABLE VARCHAR(1) NOT NULL,
	    IS_NONCONCURRENT VARCHAR(1) NOT NULL,
	    IS_UPDATE_DATA VARCHAR(1) NOT NULL,
	    REQUESTS_RECOVERY VARCHAR(1) NOT NULL,
	    JOB_DATA BLOB NULL
	)ENGINE=InnoDB;
	```

* **首先我们为SCHED_NAME添加主键索引**

	```
	MariaDB [quartz_db]> ALTER TABLE `QRTZ_JOB_DETAILS` ADD PRIMARY KEY `idx_details_sn` (SCHED_NAME) COMMENT '单一varchar字段的索引, 不指定索引前缀的长度';
	Query OK, 0 rows affected (0.009 sec)
	Records: 0  Duplicates: 0  Warnings: 0
	```

	可以看到语句执行成功了, 因为SCHED_NAME的长度是120个字符, 1个字符占用4字节, 4 * 120 = 480 < 767可以创建成功

* **接下来我们为JOB_NAME添加主键索引**

	```
	MariaDB [quartz_db]> ALTER TABLE `QRTZ_JOB_DETAILS` ADD PRIMARY KEY `idx_details_jn` (JOB_NAME) COMMENT '单一varchar字段的索引, 不指定索引前缀的长度';
	ERROR 1071 (42000): Specified key was too long; max key length is 767 bytes
	```

	可以看到语句并没有执行成功, 而是说索引列太长了, 不能超过767个字节, 因为JOB_NAME字段时200个字符, 1个字符占用4字节, 4 * 200 = 800, 所以创建失败

* **接下来我们为JOB_NAME添加前缀主键索引**

	```
	MariaDB [quartz_db]> ALTER TABLE `QRTZ_JOB_DETAILS` ADD PRIMARY KEY `pre_idx_details_jn` (JOB_NAME(190)) COMMENT '单一varchar字段的索引, 指定索引前缀的长度为190个字符';
	Query OK, 0 rows affected (0.010 sec)
	Records: 0  Duplicates: 0  Warnings: 0
	```

	这次我们依旧是使用JOB_NAME字段创建索引, **但是在创建索引的时候指定了索引前缀**, 即只使用JOB_NAME列的前190个字符进行索引, 190 * 4 = 760 < 767, 所以创建成功

## 测试复合索引的情况

* 为了方便测试, 我们在添加几个字段

	```
	ALTER TABLE QRTZ_JOB_DETAILS ADD COLUMN t1 VARCHAR(150);
	ALTER TABLE QRTZ_JOB_DETAILS ADD COLUMN t2 VARCHAR(150);
	ALTER TABLE QRTZ_JOB_DETAILS ADD COLUMN t3 VARCHAR(150);
	ALTER TABLE QRTZ_JOB_DETAILS ADD COLUMN t4 VARCHAR(150);
	ALTER TABLE QRTZ_JOB_DETAILS ADD COLUMN t5 VARCHAR(150);
	```

* **首先我们为SCHED_NAME, t1, t2, t3创建复合主键索引**

	```
	MariaDB [quartz_db]> ALTER TABLE QRTZ_JOB_DETAILS ADD PRIMARY KEY idx_details_snt1t2t3(SCHED_NAME, t1, t2, t3);
	Query OK, 0 rows affected (0.026 sec)
	Records: 0  Duplicates: 0  Warnings: 0
	```

	可以看到语句执行成功了, 因为SCHED_NAME的长度是120个字符, 1个字符占用4字节, 4 * 120 = 480 < 767可以创建成功, 4列的字符数分别是, 120, 150, 150, 150, 均满足单列字节不超过767的限制, 总的字节数是 (120 + 150 + 150 + 150) * 4 = 2280 < 3072, 也满足总长度不超过3072字节

* **接下来我们为JOB_NAME, t1, t2, t3创建复合主键索引**

	```
	MariaDB [quartz_db]> ALTER TABLE QRTZ_JOB_DETAILS ADD PRIMARY KEY idx_details_snt1t2t3(JOB_NAME, t1, t2, t3);
	ERROR 1071 (42000): Specified key was too long; max key length is 767 bytes
	```

	这次添加失败了, 因为JOB_NAME是200个字符, 200 * 4 = 800 > 767, 复合索引中的某一列的字节数超过限制, 索引创建失败

* 接下来我们为SCHED_NAME, t1, t2, t3, t4, t5创建复合主键索引

	```
	MariaDB [quartz_db]> ALTER TABLE QRTZ_JOB_DETAILS ADD PRIMARY KEY idx_details_snt1t2t3(JOB_NAME, t1, t2, t3, t4, t5);
	ERROR 1071 (42000): Specified key was too long; max key length is 767 bytes
	```

	显然这次也会失败了, 虽然SCHED_NAME, t1, t2, t3, t4, t5的单列长度均没有超出767的长度限制, 但是总的长度 120 + 150 + 150 + 150 + 150 + 150 = 870 * 4 = 3480 > 3072, 所以超出了总长度的限制

## 总结

* 通过上面一系列的试验, 我们明确知道MySQL创建索引时, 单字段索引的字段长度不能超过767字节, 超过时需要指定索引前缀；创建复合索引时, 单字段长度不能超过767字节, 且索引中所有字段的总长度不能超过3072字节, **违反这些约束时需要删减字段或是为长度较大的字段指定索引前缀或者修改字符集**. 在MySQL 5.6.28中, 字符类型的长度指的是字符数, 而不是字节数, 每个字符占用的字节数和使用的字符集相关Ï

