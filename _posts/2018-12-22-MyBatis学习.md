---
layout: post
title:  "MyBatis学习"
date:   2018-12-22 13:38:51
categories: Framework
tags: MyBatis
author: miaoqi
---

* content
{:toc}

## MyBatis-简介

MyBatis 是支持定制化 SQL、存储过程以及高级映射的优秀的持久层框架

MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集

MyBatis可以使用简单的XML或注解用于配置和原始映射，将接口和Java的POJO(Plain Old JavaObjects，普通的Java对象)映射成数据库中的记录.

### MyBatis历史

原是Apache的一个开源项目iBatis, 2010年6月这 个项目由Apache Software Foundation 迁移到了 Google Code，随着开发团队转投Google Code 旗下， iBatis3.x正式更名为MyBatis ，代码于 2013年11月迁移到Github

iBatis一词来源于“internet”和“abatis”的组合，是 一个基于Java的持久层框架。 iBatis提供的持久 层框架包括SQL Maps和Data Access Objects (DAO) 

### 为什么要使用MyBatis?

MyBatis是一个半自动化的持久化层框架。 

**JDBC**

* SQL夹在Java代码块里，耦合度高导致硬编码内伤 

* 维护不易且实际开发需求中sql是有变化，频繁修改的情况多见 

**Hibernate和JPA**

* 长难复杂SQL，对于Hibernate而言处理也不容易 
* 内部自动生产的SQL，不容易做特殊优化 
* 基于全映射的全自动框架，大量字段的POJO进行部分映射时比较困难。 导致数据库性能下降

* 对开发人员而言，核心sql还是需要自己优化 
* s**ql和java编码分开，功能边界清晰，一个专注业务、 一个专注数据** 

## MyBatis-HelloWorld

### HelloWorld简单版

**创建一张测试表**

```sql
CREATE TABLE `tbl_employee` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `last_name` varchar(255) DEFAULT NULL,
  `gender` char(1) DEFAULT NULL,
  `email` varchar(255) DEFAULT NULL,
  `dept_id` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8
```

**创建对应的javaBean**

```java
public class Employee {
    private Integer id;
    private String lastName;
    private String email;
    private String gender;
    // 省略getter, setter
}
```

**创建mybatis配置文件，sql映射文件**

MyBatis 的全局配置文件包含了影响 MyBatis 行为甚深的设置(settings)和属性(properties)信息、如数据库连接池信息等。指导着MyBatis进行工作。我们可以参照官方文件的配置示例。

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis"/>
                <property name="username" value="root"/>
                <property name="password" value="miaoqi"/>
            </dataSource>
        </environment>
    </environments>
    <!--
    将我们写好的sql映射文件一定要注册到全局配置文件(mybatis-config.xml)中
    -->
    <mappers>
        <mapper resource="EmployeeMapper.xml"/>
    </mappers>
</configuration>
```

映射文件的作用就相当于是定义Dao接口的实现类如何工作。这也是我们使用MyBatis时编写的最多的文件。

```
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.miaoqi.mybatis.dao.EmployeeMapper">
    <!--
    namespace: 名称空间; 指定接口全类名
    id: 唯一标识
    resultType: 返回值类型
    #{id}: 从传递过来的参数中取出id值
    -->
    <select id="getEmpById" resultType="com.miaoqi.mybatis.bean.Employee">
        select id, last_name lastName, gender, email
        from tbl_employee where id = #{id}
    </select>
</mapper>
```

测试

1. 根据全局配置文件，利用SqlSessionFactoryBuilder创建SqlSessionFactory

	```
	String resource = "mybatis-config.xml";
	InputStream inputStream = Resources.getResourceAsStream(resource);
	SqlSessionFactory sessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
	```

1. 使用SqlSessionFactory获取sqlSession对象。一个SqlSession对象代表和数据库的一次会话。

	```
	SqlSession sqlSession = sqlSessionFactory.openSession();
	```

3. 使用SqlSession根据方法id进行操作

	```java
	SqlSession sqlSession = sqlSessionFactory.openSession();
	try {
		Employee employee = sqlSession.selectOne("com.miaoqi.mybatis.dao.EmployeeMapper.getEmpById", 1);
		System.out.println(employee);
	} finally {
		sqlSession.close();
	}
	```

### HelloWorld接口式编程

创建一个Dao接口

```
public interface EmployeeMapper {
    public Employee getEmpById(Integer id);
}
```

修改Mapper文件

测试

* 使用SqlSession获取映射器进行操作

	```
	try {
		EmployeeMapper mapper = sqlSession.getMapper(EmployeeMapper.class);
		Employee emp = mapper.getEmpById(1);
	    System.out.println(mapper.getClass());
	    System.out.println(emp);
	} finally {
		sqlSession.close();
	}
	```

### SqlSession

SqlSession 的实例不是线程安全的，因此是不能被共享的。

SqlSession每次使用完成后需要正确关闭，这个关闭操作是必须的

SqlSession可以直接调用方法的id进行数据库操作，但是我们一般还是推荐使用SqlSession获取到Dao接口的代理类，执行代理对象的方法，可以更安全的进行类型检查操作

